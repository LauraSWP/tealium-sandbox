name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup deployment path
        id: setup
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "deploy_path=." >> $GITHUB_OUTPUT
            echo "branch_name=main" >> $GITHUB_OUTPUT
            echo "deployment_url=/" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" = "dev" ]; then
            echo "deploy_path=dev" >> $GITHUB_OUTPUT
            echo "branch_name=dev" >> $GITHUB_OUTPUT
            echo "deployment_url=/dev/" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout gh-pages branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Fetch gh-pages branch or create it if it doesn't exist
          if git ls-remote --heads origin gh-pages | grep gh-pages > /dev/null; then
            git fetch origin gh-pages
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# GitHub Pages" > README.md
            git add README.md
            git commit -m "Initial gh-pages commit"
            git push origin gh-pages
          fi
      
      - name: Checkout source branch files
        run: |
          # Create temporary directory for source files
          mkdir -p /tmp/source-files
          
          # Checkout the source branch (main or dev) into temp directory
          git --work-tree=/tmp/source-files checkout ${{ github.ref_name }} -- .
          
          # Remove .git directory from temp files
          rm -rf /tmp/source-files/.git
          rm -rf /tmp/source-files/.github
      
      - name: Update deployment directory
        run: |
          # Remove old files in deployment path (but keep other paths)
          if [ "${{ steps.setup.outputs.deploy_path }}" = "." ]; then
            # For main, remove everything except dev/ directory
            find . -maxdepth 1 ! -name 'dev' ! -name '.' ! -name '.git' -exec rm -rf {} +
          else
            # For dev, just remove the dev directory
            rm -rf ${{ steps.setup.outputs.deploy_path }}
            mkdir -p ${{ steps.setup.outputs.deploy_path }}
          fi
          
          # Copy new files from temp directory
          if [ "${{ steps.setup.outputs.deploy_path }}" = "." ]; then
            cp -r /tmp/source-files/* .
            cp -r /tmp/source-files/.gitignore . || true
          else
            cp -r /tmp/source-files/* ${{ steps.setup.outputs.deploy_path }}/
          fi
      
      - name: Update base href for dev deployment
        if: steps.setup.outputs.branch_name == 'dev'
        run: |
          # Update base href in index.html for dev deployment
          if [ -f dev/index.html ]; then
            sed -i 's|<head>|<head>\n    <base href="/tealium-sandbox/dev/">|' dev/index.html
          fi
      
      - name: Commit and push to gh-pages
        run: |
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy ${{ steps.setup.outputs.branch_name }} to ${{ steps.setup.outputs.deployment_url }} - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin gh-pages
          fi
      
      - name: Create deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.setup.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed to:** \`${{ steps.setup.outputs.deployment_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.setup.outputs.branch_name }}" = "main" ]; then
            echo "**Live URL:** https://${{ github.repository_owner }}.github.io/tealium-sandbox/" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Live URL:** https://${{ github.repository_owner }}.github.io/tealium-sandbox/dev/" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Deployments:" >> $GITHUB_STEP_SUMMARY
          echo "- **Production (main):** https://${{ github.repository_owner }}.github.io/tealium-sandbox/" >> $GITHUB_STEP_SUMMARY
          echo "- **Development (dev):** https://${{ github.repository_owner }}.github.io/tealium-sandbox/dev/" >> $GITHUB_STEP_SUMMARY

